// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Script.sol";
import {PredictionMarketFactory} from "../contracts/src/PredictionMarketFactory.sol";
import {IERC20} from "../contracts/src/interfaces/IERC20.sol";

/**
 * @title AddLiquidity
 * @notice Script to add initial liquidity to prediction market pools
 * @dev Adds USDC liquidity to all outcome token pools
 */
contract AddLiquidity is Script {
    function run() external {
        uint256 deployerKey = vm.envUint("PRIVATE_KEY");
        vm.startBroadcast(deployerKey);

        // UPDATE THIS ADDRESS with the deployed factory address
        PredictionMarketFactory factory = PredictionMarketFactory(
            0x39E54E2B5Db442640654fCD6685aa60bd72e5fCf
        );

        // UPDATE THIS with the actual market ID from CreateTestMarket
        bytes32 marketId = bytes32(0);

        // USDC address on Sepolia (6 decimals)
        IERC20 usdc = IERC20(0xcAe730E167394CD5763aEcAB91a9B8eBAF130A4B);

        // Liquidity amount: 100,000 USDC per pool
        uint256 liquidityAmount = 100000 * 1e6;

        console.log("=====================================");
        console.log("Adding Liquidity to Market");
        console.log("=====================================");
        console.log("Market ID:", vm.toString(marketId));
        console.log("Liquidity per Pool:", liquidityAmount / 1e6, "USDC");
        console.log("");

        // Check USDC balance
        uint256 balance = usdc.balanceOf(msg.sender);
        console.log("Your USDC Balance:", balance / 1e6, "USDC");

        if (balance < liquidityAmount * 3) {
            console.log("");
            console.log("ERROR: Insufficient USDC balance!");
            console.log("Required:", (liquidityAmount * 3) / 1e6, "USDC");
            console.log("Please get USDC from faucet:");
            console.log("https://faucet.circle.com/");
            revert("Insufficient balance");
        }

        // Approve factory to spend USDC
        console.log("Approving factory...");
        usdc.approve(address(factory), liquidityAmount * 3);

        // Add liquidity to all pools
        console.log("Adding liquidity to all outcome pools...");
        factory.addLiquidityToAllPools(
            marketId,
            liquidityAmount,
            0,  // min liquidity (no slippage protection for initial setup)
            block.timestamp + 3600  // 1 hour in seconds
        );

        vm.stopBroadcast();

        console.log("");
        console.log("=====================================");
        console.log("Liquidity Added Successfully!");
        console.log("=====================================");
        console.log("Market ID:", vm.toString(marketId));
        console.log("Liquidity per Pool:", liquidityAmount / 1e6, "USDC");
        console.log("Total Liquidity:", (liquidityAmount * 3) / 1e6, "USDC");
        console.log("");
        console.log("Next Steps:");
        console.log("1. Start frontend: cd frontend && npm run dev");
        console.log("2. Navigate to: http://localhost:3000/page-test-trading");
        console.log("3. Run integration tests");
        console.log("4. Execute test swaps");
        console.log("=====================================");
    }
}
